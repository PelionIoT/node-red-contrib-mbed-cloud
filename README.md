# Mbed Cloud plugin for Node-RED

node-RED node to talk to mbed-cloud. This will enable various 3rd party services that already have node-RED workflows to use connector.
 
## How to install
You can either install using npm via `TODO: not yet ready` or by cloning this repository to your `node-red/nodes` folder. More instructions can be found on the [Node-RED documentation](http://nodered.org/docs/getting-started/adding-nodes)

** How to use
Import the following code:
```
[{"id":"58dfcf7d.01abb","type":"tab","label":"Test_mbed"},{"id":"5b450868.f7e5d8","type":"list-devices","z":"58dfcf7d.01abb","server":"8d6852d0.1f9a1","x":238,"y":107,"wires":[["3c9aeffe.52052"]]},{"id":"18fb7148.e639cf","type":"http in","z":"58dfcf7d.01abb","name":"","url":"/test","method":"get","swaggerDoc":"","x":77,"y":106,"wires":[["5b450868.f7e5d8"]]},{"id":"dfc5983a.675ba8","type":"template","z":"58dfcf7d.01abb","name":"Quickstart HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"utf-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\n    <title>mbed Node-Red Quickstart</title>\n\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/normalize/6.0.0/normalize.css\">\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/foundation/6.3.1/css/foundation.min.css\">\n    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>\n    <style>{{styles}}</style> \n\n    <!--[if lt IE 9]>\n    <script src=\"http://html5shiv.googlecode.com/svn/trunk/html5.js\"></script>\n    <![endif]-->\n  </head>\n  <body onload=\"wsConnect();\" onunload=\"ws.disconnect;\">\n    <div class=\"row margin\">\n      <div class=\"small-12 columns\">\n        <div><img src=\"https://www.mbed.com/static/img/ARMmbedLogo.svg\" alt=\"ARM mbed\" style=\"width: 25%; height: 25%\"></div>\n      </div>\n    </div>\n    <div class=\"blueband\">\n      <div class=\"row\">\n        <div class=\"small-12 columns\">\n          <h1>Node-Red Quickstart</h1>\n        </div>\n      </div>\n    </div>\n    <div id=\"devices\">\n    {{#devices}}\n      <div class=\"row\" id=\"{{id}}\">\n        <div class=\"small-12 columns\">\n          <div class=\"row\">\n            <div class=\"small-12 columns\">\n              <h2>{{id}}</h2>\n            </div>\n          </div>\n          <div class=\"row\">\n            <div class=\"small-12 medium-6 columns\">\n              <h4>Presses: <span class=\"presses-value\">Unknown</span></h4>\n              <label><input type=\"checkbox\" class=\"subscribe-presses\"> Subscribe</label>\n              <button class=\"get-presses\">GET</button>\n            </div>\n            <div class=\"small-12 medium-6 columns\">\n              <h4>LED Blink Pattern</h4>\n              <div>\n                <input type=\"text\" value=\"{{blinkPattern}}\" class=\"blink-pattern\">\n              </div>\n              <div class=\"row\">\n                <div class=\"small-6 columns\">\n                  <button class=\"update-blink-pattern\">Update (PUT)</button>\n                </div>\n                <div class=\"small-6 columns text-right\">\n                  <button class=\"blink\">Blink (POST)</button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    {{/devices}}\n    {{^devices}}\n      <div class=\"small-12 columns\">\n        <div class=\"row\">\n          <div class=\"small-12 columns\">\n            <h2>No devices connected</h2>\n          </div>\n        </div>\n      </div>\n    {{/devices}}\n    </div>\n\n\n    <script type=\"text/javascript\" src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js\"></script>\n    <script type=\"text/javascript\">\n      var ws;\n      var wsUri = \"ws:\";\n      var loc = window.location;\n\n      console.log(loc);\n      if (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n      wsUri += \"//\" + loc.host + loc.pathname;\n\n      function wsConnect() {\n          console.log(\"connect\",wsUri);\n          ws = new WebSocket(wsUri);\n          ws.onmessage = function(msg) {\n              var data = JSON.parse(msg.data);\n              if (data.type == \"get-presses\" || data.type == \"subscribe-to-presses\") {\n                $('#' + data.device + ' .presses-value').html(data.data);\n              }\n          }\n          ws.onopen = function() {\n              console.log(\"connected\");\n          }\n          ws.onclose = function() {\n              setTimeout(wsConnect,3000);\n          }\n      }\n\n\n      $(function() {\n\n        $('#devices').children().each(function(index, element) {\n          var _this = $(this);\n          _this.find('.subscribe-presses').change(function() {\n            if ($(this).is(\":checked\")) {\n              _this.find('.get-presses').prop('disabled', true);\n              ws.send(JSON.stringify({type:'subscribe-to-presses', device: _this.attr('id')}));\n            } else {\n              _this.find('.get-presses').prop('disabled', false);\n              // socket.emit('unsubscribe-to-presses', {\n              //   device: _this.attr('id')\n              // });\n            }\n          });\n\n          _this.find('.get-presses').on('click', function() {\n            ws.send(JSON.stringify({type:'get-presses', device: _this.attr('id')}));\n          });\n\n          _this.find('.blink-pattern').bind('input', function() {\n            _this.find('.update-blink-pattern').addClass('active');\n          })\n\n          _this.find('.update-blink-pattern').on('click', function() {\n            ws.send(JSON.stringify({type:'update-blink-pattern', device: _this.attr('id'), data: _this.find('.blink-pattern').val()}));\n            $(this).removeClass('active');\n          });\n\n          _this.find('.blink').on('click', function() {\n            ws.send(JSON.stringify({type:'blink', device: _this.attr('id'), data: _this.find('.blink-pattern').val()}));\n          });\n        });\n\n\n        // socket.on('presses', function (data) {\n        //   console.log('presses', data);\n        //   $('#' + data.device + ' .presses-value').html(data.value);\n        // });\n      });\n    </script>\n  </body>\n</html>","x":581,"y":105,"wires":[["4a1af5e4.81851c"]]},{"id":"4a1af5e4.81851c","type":"http response","z":"58dfcf7d.01abb","name":"","x":750,"y":102,"wires":[]},{"id":"3c9aeffe.52052","type":"template","z":"58dfcf7d.01abb","name":"styles.css","field":"styles","fieldType":"msg","format":"handlebars","syntax":"plain","template":"/*\n * Copyright (c) 2013-2015, ARM Limited, All Rights Reserved\n * SPDX-License-Identifier: Apache-2.0\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\"); you may\n * not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nbody {\n  font-family: 'Open Sans', sans-serif;\n}\n\n.switch {\n  margin-bottom: 0;\n  display: inline-block;\n}\n\n.margin {\n  margin: 1rem auto;\n}\n\n.blueband {\n  background-color: #159ab5;\n}\n\n.blueband h1 {\n  color: #fff;\n}\n\n.update-blink-pattern {\n  transition: background 0.5s;\n  -webkit-transition: background 0.5s;\n  -moz-transition: background 0.5s;\n  -o-transition: background 0.5s;\n}\n\n.outlet h3 {\n  color: #fff;\n  margin: 0;\n  line-height: 78px;\n}\n\n.spinner {\n  line-height: 78px;\n}\n\n.switch .outlet-switch {\n  background-image: url('/img/lightbulb_off.png');\n  background-size: 77px 78px;\n  margin-bottom: 0;\n  display: block;\n  width: 77px;\n  height: 78px;\n}\n\n.switch .outlet-switch.checked {\n  background-image: url('/img/lightbulb_on.png');\n}\n\n.row .row.outlet {\n  padding: 0.5rem 0;\n  background-color: #0084ab;\n  border-radius: 10px;\n  margin-top: 1rem;\n}\n\n.active {\n  background-color: #fba92f;\n}\n","x":388,"y":107,"wires":[["dfc5983a.675ba8"]]},{"id":"a818e9be.aa79a8","type":"websocket in","z":"58dfcf7d.01abb","name":"","server":"9c95ef0f.864a1","client":"","x":71,"y":182,"wires":[["6f61eab3.48c274"]]},{"id":"67651d24.d15d84","type":"switch","z":"58dfcf7d.01abb","name":"","property":"type","propertyType":"msg","rules":[{"t":"eq","v":"get-presses","vt":"str"},{"t":"eq","v":"subscribe-to-presses","vt":"str"},{"t":"eq","v":"update-blink-pattern","vt":"str"},{"t":"eq","v":"blink","vt":"str"}],"checkall":"true","outputs":4,"x":362,"y":191,"wires":[["dfa6c438.a9cea8"],["e5b1a91d.63ce98"],["5cd9e61f.728708"],["c34765fa.14e508"]]},{"id":"dfa6c438.a9cea8","type":"get","z":"58dfcf7d.01abb","server":"8d6852d0.1f9a1","path":"/3200/0/5501","x":508.75,"y":179,"wires":[["97d8c7ff.586238"]]},{"id":"6f61eab3.48c274","type":"function","z":"58dfcf7d.01abb","name":"ParseData","func":"var jsonData = JSON.parse(msg.payload);\nmsg.type = jsonData.type;\nmsg.device = jsonData.device;\nmsg.payload = \"\";\nif ('data' in jsonData) {\n    msg.payload = jsonData.data;\n}\nreturn msg;","outputs":1,"noerr":0,"x":216,"y":183,"wires":[["67651d24.d15d84"]]},{"id":"369fda35.747de6","type":"websocket out","z":"58dfcf7d.01abb","name":"Quickstart Socket","server":"9c95ef0f.864a1","client":"","x":892,"y":181.5,"wires":[]},{"id":"97d8c7ff.586238","type":"function","z":"58dfcf7d.01abb","name":"CompileData","func":"var data = {type: msg.type, device: msg.device, data: msg.payload};\nmsg = {payload: data};\nreturn msg;","outputs":1,"noerr":0,"x":708,"y":181,"wires":[["369fda35.747de6"]]},{"id":"e5b1a91d.63ce98","type":"subscribe","z":"58dfcf7d.01abb","server":"8d6852d0.1f9a1","path":"/3200/0/5501","x":546,"y":223,"wires":[["97d8c7ff.586238"]]},{"id":"5cd9e61f.728708","type":"send","z":"58dfcf7d.01abb","server":"8d6852d0.1f9a1","path":"/3201/0/5853","method":"put","x":534,"y":273,"wires":[]},{"id":"c34765fa.14e508","type":"send","z":"58dfcf7d.01abb","server":"8d6852d0.1f9a1","path":"/3201/0/5853","method":"post","x":512,"y":318,"wires":[]},{"id":"8d6852d0.1f9a1","type":"mbed-cloud-sdk-config","z":"","name":"Test"},{"id":"9c95ef0f.864a1","type":"websocket-listener","z":"","path":"/test","wholemsg":"false"}]
```

# Note
This repo is under heavy development currently and should not be used by anyone other than the team doing development.

## Liscense
Apache 2.0

## Similar Projects
- [nodeJS library](https://github.com/armmbed/mbed-connector-api-node)
- [python library](https://github.com/armmbed/mbed-connector-api-python)
